name: telemt-docker (build & push)

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force build even if upstream/base images did not change"
        type: boolean
        default: false

  schedule:
    # каждые 6 часов, на 17-й минуте
    - cron: "17 */6 * * *"

  push:
    branches: [ "master" ]
    paths:
      - "Dockerfile"
      - ".github/workflows/telemt-docker-build.yml"

concurrency:
  group: telemt-docker-build
  cancel-in-progress: true

permissions:
  contents: write

env:
  IMAGE_NAME: whn0thacked/telemt-docker

  UPSTREAM_OWNER: telemt
  UPSTREAM_REPO: telemt
  UPSTREAM_REF: main

  RUST_IMAGE: docker.io/library/rust:alpine
  DISTROLESS_IMAGE: gcr.io/distroless/static:nonroot

  STATE_FILE: .github/telemt-docker/state.json

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3 <!--citation:4-->

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 <!--citation:5-->

      - name: Compute upstream SHA + base image digests, compare with state
        id: check
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$(dirname "${STATE_FILE}")"

          # read previous state (if any)
          prev_upstream_sha=""
          prev_rust_digest=""
          prev_distroless_digest=""

          if [ -f "${STATE_FILE}" ]; then
            prev_upstream_sha="$(jq -r '.upstream_sha // ""' "${STATE_FILE}")"
            prev_rust_digest="$(jq -r '.base_images.rust_alpine_manifest_digest // ""' "${STATE_FILE}")"
            prev_distroless_digest="$(jq -r '.base_images.distroless_static_nonroot_manifest_digest // ""' "${STATE_FILE}")"
          fi

          # upstream head sha (authenticated to reduce rate-limit issues)
          upstream_sha="$(
            curl -fsSL \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ github.token }}" \
              "https://api.github.com/repos/${UPSTREAM_OWNER}/${UPSTREAM_REPO}/commits/${UPSTREAM_REF}" \
            | jq -r '.sha'
          )"

          # manifest-list digest for tags (multi-arch): use buildx imagetools inspect <!--citation:9-->
          rust_digest="$(
            docker buildx imagetools inspect "${RUST_IMAGE}" --format '{{json .Manifest}}' \
            | jq -r '.digest'
          )"

          distroless_digest="$(
            docker buildx imagetools inspect "${DISTROLESS_IMAGE}" --format '{{json .Manifest}}' \
            | jq -r '.digest'
          )"

          changed=false
          if [ -z "${prev_upstream_sha}" ] || [ "${prev_upstream_sha}" != "${upstream_sha}" ]; then changed=true; fi
          if [ -z "${prev_rust_digest}" ] || [ "${prev_rust_digest}" != "${rust_digest}" ]; then changed=true; fi
          if [ -z "${prev_distroless_digest}" ] || [ "${prev_distroless_digest}" != "${distroless_digest}" ]; then changed=true; fi

          short_sha="${upstream_sha:0:12}"

          {
            echo "changed=${changed}"
            echo "upstream_sha=${upstream_sha}"
            echo "short_sha=${short_sha}"
            echo "rust_digest=${rust_digest}"
            echo "distroless_digest=${distroless_digest}"
          } >> "${GITHUB_OUTPUT}"

      - name: Build decision (log)
        shell: bash
        run: |
          echo "changed=${{ steps.check.outputs.changed }}"
          echo "upstream_sha=${{ steps.check.outputs.upstream_sha }}"
          echo "rust_digest=${{ steps.check.outputs.rust_digest }}"
          echo "distroless_digest=${{ steps.check.outputs.distroless_digest }}"

      - name: Build and push (multi-arch)
        if: |
          steps.check.outputs.changed == 'true' ||
          github.event_name == 'push' ||
          (github.event_name == 'workflow_dispatch' && inputs.force == true)
        uses: docker/build-push-action@v6 <!--citation:6-->
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64

          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:telemt-${{ steps.check.outputs.short_sha }}

          build-args: |
            TELEMT_REPO=https://github.com/telemt/telemt.git
            TELEMT_REF=${{ steps.check.outputs.upstream_sha }}

          cache-from: type=gha
          cache-to: type=gha,mode=max

          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ steps.check.outputs.upstream_sha }}

      - name: Update state file (only when auto-change detected)
        if: steps.check.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          now="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          jq -n \
            --arg upstream_owner "${UPSTREAM_OWNER}" \
            --arg upstream_repo "${UPSTREAM_REPO}" \
            --arg upstream_ref "${UPSTREAM_REF}" \
            --arg upstream_sha "${{ steps.check.outputs.upstream_sha }}" \
            --arg rust_digest "${{ steps.check.outputs.rust_digest }}" \
            --arg distroless_digest "${{ steps.check.outputs.distroless_digest }}" \
            --arg built_at_utc "${now}" \
            '{
              upstream: {
                owner: $upstream_owner,
                repo: $upstream_repo,
                ref: $upstream_ref
              },
              upstream_sha: $upstream_sha,
              base_images: {
                rust_alpine_manifest_digest: $rust_digest,
                distroless_static_nonroot_manifest_digest: $distroless_digest
              },
              built_at_utc: $built_at_utc
            }' > "${STATE_FILE}"

      - name: Commit & push updated state.json
        if: steps.check.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "${STATE_FILE}"

          if git diff --cached --quiet; then
            echo "No state changes to commit."
            exit 0
          fi

          git commit -m "ci: update build state (telemt ${{ steps.check.outputs.short_sha }})"
          git push
